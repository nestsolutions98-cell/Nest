<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ course_name }} - Course Profile</title>
    <style>
      /* Keep specific English labels readable in RTL pages */
      .keep-en { direction: ltr; unicode-bidi: plaintext; }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=rtl1">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b mb-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <a href="/" class="text-xl font-bold text-gray-900 hover:text-blue-600 flex items-center">
                    <i class="fas fa-dumbbell text-blue-600 mr-2"></i>
                    <span class="keep-en notranslate">Sports Club Management</span>
                </a>

                <div class="flex items-center gap-2">
                    <button id="langToggleBtn"
                            class="ml-2 bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded text-sm"
                            type="button">עברית</button>
                    <a href="/"
                       class="ml-2 btn btn-secondary bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span data-i18n="Back">Back</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Course Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-900">{{ course_name }}</h1>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-blue-600 font-medium" data-i18n="Coach">Coach</div>
                    <div class="text-lg font-semibold">{{ course.teacher }}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-green-600 font-medium" data-i18n="Sessions">Sessions</div>
                    <div class="text-lg font-semibold">{{ course.sessions_count }}</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-sm text-yellow-600 font-medium" data-i18n="Meetings Left">Meetings Left</div>
                    <div class="text-lg font-semibold">{{ meetings_left }}</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-purple-600 font-medium" data-i18n="Enrolled Students">Enrolled Students</div>
                    <div class="text-lg font-semibold" id="studentCount">{{ students|length }}</div>
                </div>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <span class="mr-4">
                    <i class="fas fa-calendar mr-1"></i>
                    <span data-i18n="Start">Start</span>: {{ course.start_date }}
                </span>
                <span>
                    <i class="fas fa-calendar-check mr-1"></i>
                    <span data-i18n="End">End</span>: {{ course.end_date }}
                </span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Students Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-users text-blue-600 mr-2"></i>
                        <span data-i18n="Enrolled Students">Enrolled Students</span>
                    </h2>
                    <button class="btn btn-info bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm"
                            onclick="openEnrollStudentsModal()">
                        <i class="fas fa-user-plus mr-1"></i>
                        <span data-i18n="Enroll Students">Enroll Students</span>
                    </button>
                </div>
                <div class="mb-4">
                    <input
                        type="text"
                        id="studentSearch"
                        placeholder="Search students..."
                        data-i18n-placeholder="Search students..."
                        class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <ul id="studentsList" class="space-y-2 max-h-96 overflow-y-auto">
                    {% for student in students %}
                        <li class="flex items-center justify-between group student-item p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                            data-name="{{ student.first_name|lower }} {{ student.fathers_name|lower }}">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-blue-600 text-sm"></i>
                                </div>
                                <a href="/student/{{ student.id }}" class="font-medium text-blue-700 hover:underline">
                                    {{ student.first_name }} {{ student.fathers_name }}
                                </a>
                            </div>
                            <button
                                class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-50"
                                onclick="unenrollStudent({{ student.id }}, {{ (student.first_name + ' ' + student.fathers_name)|tojson }})"
                                title="Unenroll student"
                                data-i18n-title="Unenroll student">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                    {% else %}
                        <li class="text-gray-500 text-center py-8" data-i18n="No students enrolled yet.">No students enrolled yet.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Meetings Log Section -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-calendar-alt text-green-600 mr-2"></i>
                        <span data-i18n="Meetings Log">Meetings Log</span>
                    </h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500">
                            {{ meetings|length }} <span data-i18n="meetings">meetings</span>
                        </span>
                        <button class="btn btn-success bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm"
                                onclick="openAddMeetingModal()">
                            <i class="fas fa-plus mr-1"></i>
                            <span data-i18n="Add Meeting">Add Meeting</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for meeting in meetings %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors" data-meeting-id="{{ meeting.id }}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-calendar-day text-green-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">{{ meeting.date }}</div>
                                        <div class="text-sm text-gray-600">
                                            {{ meeting.notes or '<span data-i18n="No notes">No notes</span>' | safe }}
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
                                        type="button"
                                        onclick="deleteMeeting({{ meeting.id }})">
                                    <i class="fas fa-trash mr-1"></i>
                                    <span data-i18n="Delete">Delete</span>
                                </button>
                            </div>
                            <div class="flex items-center text-xs text-gray-500">
                                <i class="fas fa-users mr-1"></i>
                                <span>
                                    {{ meeting.attendance|selectattr('present')|list|length }}/{{ meeting.attendance|length }}
                                    <span data-i18n="attended">attended</span>
                                </span>
                                <span class="mx-2">•</span>
                                <span>{{ meeting.attendance|length }}</span>
                                <span data-i18n="total students">total students</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-times text-4xl mb-4 text-gray-300"></i>
                            <div data-i18n="No meetings scheduled yet.">No meetings scheduled yet.</div>
                            <div class="text-sm mt-2" data-i18n='Click "Add Meeting" to schedule the first session.'>
                                Click "Add Meeting" to schedule the first session.
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Meeting Modal -->
    <div id="addMeetingModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-full max-w-lg relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl" onclick="closeAddMeetingModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" data-i18n="Add Meeting & Attendance">Add Meeting & Attendance</h3>
            <form id="addMeetingForm">
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Date">Date</label>
                    <input type="date" id="meetingDate" name="date" class="form-input w-full" required />
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Notes">Notes</label>
                    <input type="text" id="meetingNotes" name="notes" class="form-input w-full" />
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Mark Attendance">Mark Attendance</label>
                    <div class="max-h-48 overflow-y-auto border rounded p-2">
                        {% for student in students %}
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="attend-{{ student.id }}" name="attendance" value="{{ student.id }}" class="mr-2">
                            <label for="attend-{{ student.id }}">{{ student.first_name }} {{ student.fathers_name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeAddMeetingModal()" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" data-i18n="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-i18n="Add Meeting">Add Meeting</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Meeting Modal -->
    <div id="editMeetingModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-full max-w-lg relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl" onclick="closeEditMeetingModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" data-i18n="Edit Meeting & Attendance">Edit Meeting & Attendance</h3>
            <form id="editMeetingForm">
                <input type="hidden" id="editMeetingId" name="meeting_id" />
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Date">Date</label>
                    <input type="date" id="editMeetingDate" name="date" class="form-input w-full" required />
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Notes">Notes</label>
                    <input type="text" id="editMeetingNotes" name="notes" class="form-input w-full" />
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1" data-i18n="Mark Attendance">Mark Attendance</label>
                    <div id="editAttendanceList" class="max-h-48 overflow-y-auto border rounded p-2"></div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeEditMeetingModal()" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" data-i18n="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-i18n="Save Changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enroll Students Modal -->
    <div id="enrollStudentsModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-full max-w-lg relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl" onclick="closeEnrollStudentsModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" data-i18n="Enroll Students">Enroll Students</h3>
            <div class="mb-4">
                <label class="block font-semibold mb-2" data-i18n="Available Students">Available Students</label>
                <div class="mb-3">
                    <input
                        type="text"
                        id="availableStudentSearch"
                        placeholder="Search available students..."
                        data-i18n-placeholder="Search available students..."
                        class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div id="availableStudentsList" class="max-h-64 overflow-y-auto border rounded p-2">
                    <!-- Students will be loaded here -->
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="closeEnrollStudentsModal()" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" data-i18n="Cancel">Cancel</button>
                <button type="button" onclick="enrollSelectedStudents()" class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-i18n="Enroll Selected">Enroll Selected</button>
            </div>
        </div>
    </div>

    <!-- Pass server data to external JS -->
    <script>
      window.COURSE_CTX = {
        courseId: {{ course_id }},
        courseName: {{ course_name|tojson }},
        students: {{ students|tojson }},
        enrolledStudentIds: {{ students|map(attribute='id')|list|tojson }}
      };
    </script>

    <!-- Page JS -->
    <script src="{{ url_for('static', filename='js/course_profile.js') }}" defer></script>
</body>
</html>
